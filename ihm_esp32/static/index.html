<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>IHM - NEOCOUDE-HD-15</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(0,0,0,0.4);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 16px;
            font-weight: 700;
        }

        .header-status {
            display: flex;
            gap: 12px;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
            box-shadow: 0 0 10px currentColor;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        /* Container principal */
        .main-container {
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Card de Estado da M√°quina - DESTAQUE */
        .state-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .state-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .state-description {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        /* Estados com cores espec√≠ficas */
        .state-card.state-idle { border-color: #95a5a6; }
        .state-card.state-aguarda-direcao { border-color: #f39c12; }
        .state-card.state-dobrando { border-color: #2ecc71; }
        .state-card.state-retornando { border-color: #3498db; }
        .state-card.state-aguarda-proxima { border-color: #9b59b6; }
        .state-card.state-completo { border-color: #27ae60; }
        .state-card.state-emergencia { border-color: #e74c3c; background: rgba(231,76,60,0.2); }
        .state-card.state-manual { border-color: #e67e22; }

        /* Grid de informa√ß√µes */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .info-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .info-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 700;
        }

        .info-value.encoder {
            color: #2ecc71;
            text-shadow: 0 0 15px rgba(46,204,113,0.5);
            transition: all 0.2s ease;
        }

        .info-value.encoder.moving {
            animation: encoderPulse 0.6s ease-in-out infinite;
        }

        @keyframes encoderPulse {
            0%, 100% {
                transform: scale(1);
                color: #2ecc71;
                text-shadow: 0 0 15px rgba(46,204,113,0.5);
            }
            50% {
                transform: scale(1.05);
                color: #27ae60;
                text-shadow: 0 0 25px rgba(46,204,113,0.8);
            }
        }

        .info-value.counter {
            color: #3498db;
        }

        /* √Çngulos em grid compacto */
        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .angles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .angle-card {
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .angle-card:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.2);
        }

        .angle-card.active {
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46,204,113,0.3);
        }

        .angle-card-label {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .angle-card-value {
            font-size: 20px;
            font-weight: 700;
        }

        .angle-card-unit {
            font-size: 14px;
            opacity: 0.6;
        }

        /* Dimmer de Velocidade */
        .dimmer-section {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dimmer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dimmer-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .dimmer-value {
            font-size: 20px;
            font-weight: 700;
            color: #3498db;
        }

        .dimmer-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #2ecc71 0%, #f39c12 50%, #e74c3c 100%);
            border-radius: 20px;
            outline: none;
            cursor: pointer;
        }

        .dimmer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 50px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .dimmer-slider::-moz-range-thumb {
            width: 30px;
            height: 50px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .dimmer-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 10px;
            opacity: 0.6;
        }

        /* Controles de Motor */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            padding: 18px 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #2ecc71;
            border-color: #2ecc71;
            box-shadow: 0 0 20px rgba(46,204,113,0.5);
        }

        .control-btn.stop {
            background: rgba(231,76,60,0.3);
            border-color: rgba(231,76,60,0.5);
        }

        .control-btn.stop:active {
            background: #e74c3c;
        }

        .control-icon {
            font-size: 28px;
        }

        /* Switches/Toggles */
        .toggles-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-info {
            flex: 1;
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .toggle-description {
            font-size: 10px;
            opacity: 0.6;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #2ecc71;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* Bot√£o Reset Contador */
        .reset-btn {
            background: rgba(231,76,60,0.2);
            border: 2px solid rgba(231,76,60,0.4);
            border-radius: 8px;
            color: #fff;
            font-size: 10px;
            padding: 6px 10px;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s;
        }

        .reset-btn:active {
            background: #e74c3c;
        }

        /* Footer */
        .footer {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            text-align: center;
            font-size: 10px;
            opacity: 0.7;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .footer a {
            color: #2ecc71;
            text-decoration: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 28px;
            font-weight: 700;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .modal-btn.confirm {
            background: #2ecc71;
            border-color: #2ecc71;
        }

        /* Overlay de erro */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(231,76,60,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .overlay.active {
            display: flex;
        }

        .overlay-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .overlay-message {
            font-size: 36px;
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Navega√ß√£o por Abas */
        .tab-nav {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            flex: 1;
            min-width: 100px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            font-weight: 600;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-btn:active {
            background: rgba(255,255,255,0.1);
        }

        .tab-btn.active {
            color: #2ecc71;
            border-bottom: 3px solid #2ecc71;
            background: rgba(46,204,113,0.1);
        }

        .tab-icon {
            font-size: 18px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Se√ß√£o WiFi */
        .wifi-section {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .wifi-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wifi-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .wifi-status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .wifi-status-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .wifi-status-value {
            font-size: 14px;
            font-weight: 600;
            word-break: break-all;
        }

        .wifi-status-value.connected {
            color: #2ecc71;
        }

        .wifi-status-value.disconnected {
            color: #e74c3c;
        }

        .wifi-input-group {
            margin-bottom: 12px;
        }

        .wifi-input-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
            display: block;
        }

        .wifi-input {
            width: 100%;
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            padding: 10px 12px;
            outline: none;
            transition: border-color 0.3s;
        }

        .wifi-input:focus {
            border-color: #2ecc71;
        }

        .wifi-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .wifi-btn {
            width: 100%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .wifi-btn:active {
            transform: scale(0.98);
        }

        .wifi-btn.primary {
            background: #2ecc71;
            border-color: #2ecc71;
        }

        .wifi-btn.danger {
            background: rgba(231,76,60,0.3);
            border-color: rgba(231,76,60,0.5);
        }

        .wifi-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wifi-networks-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .wifi-network-item {
            background: rgba(255,255,255,0.08);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .wifi-network-item:active {
            background: rgba(255,255,255,0.15);
        }

        .wifi-network-item.selected {
            border-color: #2ecc71;
            background: rgba(46,204,113,0.15);
        }

        .wifi-network-ssid {
            font-size: 14px;
            font-weight: 500;
        }

        .wifi-network-signal {
            font-size: 12px;
            opacity: 0.7;
        }

        .wifi-loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .wifi-loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #2ecc71;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .wifi-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .wifi-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: #2ecc71;
        }

        .wifi-checkbox-label {
            font-size: 13px;
        }

        /* ========================================
           CALIBRA√á√ÉO - ESTILOS
           ======================================== */
        .calib-section {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.15) 0%, rgba(103, 58, 183, 0.1) 100%);
            border: 2px solid rgba(156, 39, 176, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .calib-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ce93d8;
        }

        .calib-status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            margin-left: auto;
        }

        .calib-status-badge.active {
            background: rgba(156, 39, 176, 0.4);
            animation: pulse 1.5s infinite;
        }

        .calib-status-badge.idle {
            background: rgba(100, 100, 100, 0.4);
        }

        /* Digital Twin - Disco Animado */
        .calib-twin-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
        }

        .calib-motor-svg {
            width: 150px;
            height: 150px;
            transition: transform 0.1s ease-out;
        }

        .calib-motor-svg.spinning {
            animation: spinFast 0.5s linear infinite;
        }

        @keyframes spinFast {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .calib-motor-center {
            fill: #9c27b0;
            filter: drop-shadow(0 0 10px rgba(156, 39, 176, 0.5));
        }

        .calib-motor-teeth {
            fill: #7b1fa2;
        }

        .calib-motor-highlight {
            fill: #ce93d8;
        }

        /* Barra de Progresso */
        .calib-progress-container {
            margin-bottom: 15px;
        }

        .calib-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .calib-progress-step {
            color: #ce93d8;
            font-weight: 600;
        }

        .calib-progress-percent {
            opacity: 0.7;
        }

        .calib-progress-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .calib-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7b1fa2 0%, #9c27b0 50%, #ce93d8 100%);
            border-radius: 6px;
            transition: width 0.5s ease-out;
            position: relative;
        }

        .calib-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .calib-progress-description {
            font-size: 13px;
            text-align: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            min-height: 40px;
        }

        /* Checkbox Estilizado */
        .calib-checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calib-checkbox-container:hover {
            background: rgba(255,255,255,0.12);
        }

        .calib-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(156, 39, 176, 0.5);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .calib-checkbox.checked {
            background: #9c27b0;
            border-color: #9c27b0;
        }

        .calib-checkbox-icon {
            color: white;
            font-size: 16px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }

        .calib-checkbox.checked .calib-checkbox-icon {
            opacity: 1;
            transform: scale(1);
        }

        .calib-checkbox-text {
            flex: 1;
        }

        .calib-checkbox-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .calib-checkbox-desc {
            font-size: 11px;
            opacity: 0.7;
        }

        /* Bot√µes de Calibra√ß√£o */
        .calib-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .calib-btn {
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 2px solid transparent;
        }

        .calib-btn:active {
            transform: scale(0.98);
        }

        .calib-btn-start {
            background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
            color: white;
            border-color: #9c27b0;
        }

        .calib-btn-start:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.5);
        }

        .calib-btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .calib-btn-abort {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-color: rgba(231, 76, 60, 0.5);
            display: none;
        }

        .calib-btn-abort.visible {
            display: flex;
        }

        .calib-btn-abort:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        .calib-btn-icon {
            font-size: 20px;
        }

        /* Resultados da Calibra√ß√£o */
        .calib-results {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid rgba(46, 204, 113, 0.3);
            border-radius: 12px;
        }

        .calib-results.visible {
            display: block;
        }

        .calib-results-title {
            font-size: 14px;
            font-weight: 600;
            color: #2ecc71;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calib-results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .calib-result-item {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .calib-result-label {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .calib-result-value {
            font-size: 16px;
            font-weight: 700;
            color: #2ecc71;
        }

        /* Bloqueio durante calibra√ß√£o */
        .calib-lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 500;
            pointer-events: all;
        }

        .calib-lock-overlay.active {
            display: block;
        }

        /* Responsivo */
        @media (min-width: 768px) {
            .main-container {
                padding: 20px 30px;
            }

            .info-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .state-card {
                padding: 25px;
            }

            .state-icon {
                font-size: 56px;
            }

            .state-name {
                font-size: 24px;
            }
        }

        @media (max-height: 600px) {
            .state-card {
                padding: 12px;
            }

            .state-icon {
                font-size: 36px;
                margin-bottom: 5px;
            }

            .state-name {
                font-size: 16px;
            }

            .state-description {
                font-size: 12px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de erro -->
    <div class="overlay" id="errorOverlay">
        <div class="overlay-icon">‚ö†Ô∏è</div>
        <div class="overlay-message" id="errorMessage">DESLIGADO</div>
    </div>

    <!-- Modal para editar √¢ngulo -->
    <div class="modal" id="angleModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Editar √Çngulo - Dobra 1</div>
            <input type="number" class="modal-input" id="angleInput" placeholder="0.0" step="0.1" min="0" max="360">
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn confirm" onclick="saveAngle()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title">NEOCOUDE-HD-15</div>
        <div class="header-status">
            <div class="status-item">
                <span class="status-dot" id="wsStatus"></span>
                <span id="wsText">WS</span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="clpStatus"></span>
                <span id="clpText">CLP</span>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="main-container">
        <!-- ========== ABA OPERA√á√ÉO ========== -->
        <div class="tab-content active" id="tab-operacao">
        <!-- Card de Estado da M√°quina -->
        <div class="state-card" id="stateCard">
            <div class="state-icon" id="stateIcon">‚è∏Ô∏è</div>
            <div class="state-name" id="stateName">PARADA</div>
            <div class="state-description" id="stateDescription">
                M√°quina parada. Pressione o pedal para iniciar uma opera√ß√£o.
            </div>
        </div>

        <!-- Grid de Informa√ß√µes -->
        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">Posi√ß√£o Encoder <span id="encoderDirection" style="font-size: 18px;">‚Äî</span></div>
                <div class="info-value encoder" id="encoderValue">0.0¬∞</div>
                <div style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
                    <span id="encoderPulses">0</span> pulsos
                </div>
            </div>
            <div class="info-card">
                <div class="info-label">Dobra Atual</div>
                <div class="info-value" id="currentBend">1</div>
            </div>
            <div class="info-card">
                <div class="info-label">√Çngulo Alvo</div>
                <div class="info-value" id="targetAngle">0.0¬∞</div>
            </div>
            <div class="info-card">
                <div class="info-label">Pe√ßas Produzidas</div>
                <div class="info-value counter" id="pieceCounter">0</div>
                <button class="reset-btn" onclick="resetCounter()">ZERAR</button>
            </div>
        </div>

        <!-- √Çngulos Programados -->
        <div class="section-title">√Çngulos Programados</div>
        <div class="angles-grid">
            <div class="angle-card" id="angleCard1" onclick="editAngle(1)">
                <div class="angle-card-label">DOBRA 1</div>
                <div class="angle-card-value">
                    <span id="angle1">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
            <div class="angle-card" id="angleCard2" onclick="editAngle(2)">
                <div class="angle-card-label">DOBRA 2</div>
                <div class="angle-card-value">
                    <span id="angle2">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
            <div class="angle-card" id="angleCard3" onclick="editAngle(3)">
                <div class="angle-card-label">DOBRA 3</div>
                <div class="angle-card-value">
                    <span id="angle3">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
        </div>

        <!-- Dimmer de Velocidade -->
        <div class="dimmer-section">
            <div class="dimmer-header">
                <span class="dimmer-label">Velocidade do Motor</span>
                <span class="dimmer-value"><span id="speedValue">5.0</span> RPM</span>
            </div>
            <input type="range" class="dimmer-slider" id="speedSlider" min="0" max="19" step="0.5" value="5">
            <div class="dimmer-marks">
                <span>0</span>
                <span>5</span>
                <span>10</span>
                <span>15</span>
                <span>19 RPM</span>
            </div>
        </div>

        <!-- Controles de Motor -->
        <div class="section-title">Controle do Motor</div>
        <div class="controls-grid">
            <button class="control-btn" id="btnForward" onclick="startMotor('forward')">
                <div class="control-icon">‚¨ÜÔ∏è</div>
                <div>AVAN√áAR</div>
            </button>
            <button class="control-btn stop" onclick="stopMotor()">
                <div class="control-icon">‚èπÔ∏è</div>
                <div>PARAR</div>
            </button>
            <button class="control-btn" id="btnReverse" onclick="startMotor('reverse')">
                <div class="control-icon">‚¨áÔ∏è</div>
                <div>RECUAR</div>
            </button>
        </div>

        <!-- Toggles de Configura√ß√£o -->
        <div class="section-title">Configura√ß√µes</div>
        <div class="toggles-section">
            <div class="toggle-card">
                <div class="toggle-info">
                    <div class="toggle-label">PEDAL SEGURA</div>
                    <div class="toggle-description">Exige segurar pedal</div>
                </div>
                <div class="toggle-switch" id="pedalSeguraToggle" onclick="togglePedalSegura()"></div>
            </div>
            <div class="toggle-card">
                <div class="toggle-info">
                    <div class="toggle-label">MODO MANUAL</div>
                    <div class="toggle-description">Controle direto</div>
                </div>
                <div class="toggle-switch" id="manualModeToggle" onclick="toggleManualMode()"></div>
            </div>
        </div>
        </div><!-- Fim tab-operacao -->

        <!-- ========== ABA WIFI ========== -->
        <div class="tab-content" id="tab-wifi">
            <!-- Status das Redes -->
            <div class="wifi-section">
                <div class="wifi-section-title">üì° Status das Redes</div>
                <div class="wifi-status-grid">
                    <div class="wifi-status-card">
                        <div class="wifi-status-label">Rede AP (Tablet)</div>
                        <div class="wifi-status-value connected" id="wifiApSsid">IHM_NEOCOUDE</div>
                        <div class="wifi-status-value" style="font-size:11px; margin-top:5px; opacity:0.8;">Senha: dobradeira123</div>
                        <div class="wifi-status-value" id="wifiApIp" style="font-size:12px; margin-top:3px;">192.168.50.1</div>
                    </div>
                    <div class="wifi-status-card">
                        <div class="wifi-status-label">Dongle USB (Internet)</div>
                        <div class="wifi-status-value" id="wifiDongleStatus">Verificando...</div>
                        <div class="wifi-status-value" id="wifiDongleIp" style="font-size:12px; margin-top:5px;">-</div>
                    </div>
                </div>

                <!-- Tailscale (Acesso Remoto) -->
                <div class="wifi-status-card" style="margin-top:10px;">
                    <div class="wifi-status-label">üîí Tailscale (Acesso Remoto)</div>
                    <div class="wifi-status-value" id="wifiTailscaleIp" style="font-size:14px; margin-top:5px;">Verificando...</div>
                    <div style="font-size:11px; opacity:0.7; margin-top:5px;">Acesse de qualquer lugar pelo IP acima</div>
                </div>

                <button class="wifi-btn" onclick="refreshWifiStatus()" style="margin-top:12px;">
                    üîÑ Atualizar Status
                </button>
            </div>

            <!-- Dongle WiFi USB -->
            <div class="wifi-section" id="wifiDongleSection">
                <div class="wifi-section-title">üì∂ Configura√ß√£o Internet (Dongle USB)</div>

                <!-- Aviso se dongle n√£o detectado -->
                <div id="wifiDongleNotDetected" style="display:none; text-align:center; padding:15px; opacity:0.7;">
                    ‚ö†Ô∏è Dongle WiFi USB n√£o detectado.<br>
                    Conecte um adaptador WiFi USB para habilitar internet.
                </div>

                <!-- Formul√°rio de conex√£o (vis√≠vel se dongle detectado) -->
                <div id="wifiDongleForm">
                    <div class="wifi-input-group">
                        <label class="wifi-input-label">SSID (Nome da Rede)</label>
                        <input type="text" class="wifi-input" id="wifiSsidInput" placeholder="Ex: Optimos Construtora">
                    </div>
                    <div class="wifi-input-group">
                        <label class="wifi-input-label">Senha</label>
                        <input type="password" class="wifi-input" id="wifiPasswordInput" placeholder="Senha da rede WiFi">
                    </div>
                    <label class="wifi-checkbox">
                        <input type="checkbox" id="wifiAutoConnect" checked>
                        <span class="wifi-checkbox-label">Conectar automaticamente ao iniciar</span>
                    </label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                        <button class="wifi-btn primary" onclick="connectWifi()">
                            üîó Conectar
                        </button>
                        <button class="wifi-btn danger" onclick="disconnectWifi()" id="btnDisconnectWifi" disabled>
                            ‚ùå Desconectar
                        </button>
                    </div>
                    <button class="wifi-btn" onclick="saveWifiConfig()">
                        üíæ Salvar Configura√ß√£o
                    </button>
                </div>
            </div>

            <!-- Redes Dispon√≠veis -->
            <div class="wifi-section">
                <div class="wifi-section-title">üîç Redes Dispon√≠veis</div>
                <button class="wifi-btn" onclick="scanWifiNetworks()" id="btnScanWifi">
                    üì° Escanear Redes
                </button>
                <div id="wifiNetworksList" class="wifi-networks-list" style="margin-top:12px;">
                    <!-- Redes aparecer√£o aqui -->
                </div>
            </div>

            <!-- NAT / Compartilhamento -->
            <div class="wifi-section">
                <div class="wifi-section-title">üåê Compartilhamento de Internet</div>
                <p style="font-size:12px; opacity:0.7; margin-bottom:12px;">
                    Quando habilitado, dispositivos conectados na rede IHM_NEOCOUDE ter√£o acesso √† internet atrav√©s do dongle WiFi USB.
                </p>
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:14px;">NAT (Internet para AP)</span>
                    <div class="toggle-switch" id="wifiNatToggle" onclick="toggleNat()"></div>
                </div>
                <div id="wifiNatStatus" style="font-size:12px; opacity:0.7; text-align:center;">
                    Status: Verificando...
                </div>
            </div>

            <!-- ========================================
                 AUTO-CALIBRA√á√ÉO - DESATIVADO 02/Jan/2026
                 ======================================== -->
            <!-- Calibra√ß√£o manual via ajuste de √¢ngulos (compensa in√©rcia manualmente) -->
            <!-- Para reativar, descomentar este bloco e c√≥digo backend -->

            <!-- <div class="calib-section" id="calibSection" style="display:none;">
                <div class="calib-section-title">
                    üéØ Auto-Calibra√ß√£o Inteligente (DESATIVADO)
                    <span class="calib-status-badge idle">DESATIVADO</span>
                </div>
                <div style="text-align:center; padding:20px; opacity:0.7;">
                    ‚ö†Ô∏è Auto-calibra√ß√£o desativada.<br><br>
                    Ajuste os √¢ngulos manualmente para compensar a in√©rcia da m√°quina.<br>
                    Exemplo: Se precisa de 90¬∞, configure 89¬∞ para compensar o atraso de parada.
                </div>
            </div> -->
        </div><!-- Fim tab-wifi -->
    </div>

    <!-- Navega√ß√£o por Abas (no rodap√©) -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('operacao')">
            <span class="tab-icon">üè≠</span>
            <span>Opera√ß√£o</span>
        </button>
        <button class="tab-btn" onclick="switchTab('wifi')">
            <span class="tab-icon">‚öôÔ∏è</span>
            <span>Configura√ß√µes</span>
        </button>
    </div>

    <!-- Footer -->
    <div class="footer">
        Desenvolvido por Eng. <a href="https://www.linkedin.com/in/lucas-william-junges-a95b00143" target="_blank">Lucas William Junges</a> | IHM Web v2.0
    </div>

    <script>
        // ========================================
        // ESTADO DA APLICA√á√ÉO
        // ========================================
        let ws = null;
        let currentBendEdit = null;
        let currentSpeed = 5.0;
        let pedalSeguraEnabled = false;
        let manualModeEnabled = false;

        // Mapeamento de estados para descri√ß√µes amig√°veis
        const STATE_INFO = {
            'ST_IDLE': {
                icon: '‚è∏Ô∏è',
                name: 'PARADA',
                description: 'M√°quina parada. Pressione o pedal para iniciar uma opera√ß√£o.',
                cssClass: 'state-idle'
            },
            'ST_AGUARDA_DIRECAO': {
                icon: 'üéØ',
                name: 'AGUARDANDO DIRE√á√ÉO',
                description: 'Escolha a dire√ß√£o: pressione pedal de avan√ßo ou recuo.',
                cssClass: 'state-aguarda-direcao'
            },
            'ST_DOBRANDO': {
                icon: 'üîÑ',
                name: 'DOBRANDO',
                description: 'Executando dobra. Motor em movimento at√© atingir o √¢ngulo alvo.',
                cssClass: 'state-dobrando'
            },
            'ST_RETORNANDO': {
                icon: '‚Ü©Ô∏è',
                name: 'RETORNANDO',
                description: 'Retornando para posi√ß√£o zero. Aguarde a conclus√£o.',
                cssClass: 'state-retornando'
            },
            'ST_AGUARDA_PROXIMA': {
                icon: '‚è≥',
                name: 'PR√ìXIMA DOBRA',
                description: 'Dobra conclu√≠da! Pressione o pedal para a pr√≥xima dobra.',
                cssClass: 'state-aguarda-proxima'
            },
            'ST_COMPLETO': {
                icon: '‚úÖ',
                name: 'SEQU√äNCIA COMPLETA',
                description: 'Todas as 3 dobras foram conclu√≠das com sucesso!',
                cssClass: 'state-completo'
            },
            'ST_EMERGENCIA': {
                icon: 'üö®',
                name: 'EMERG√äNCIA',
                description: 'PARADA DE EMERG√äNCIA ATIVA! Resolva o problema e reinicie.',
                cssClass: 'state-emergencia'
            },
            'ST_MANUAL': {
                icon: 'üîß',
                name: 'MODO MANUAL',
                description: 'Controle manual ativo. Use os bot√µes para mover o motor.',
                cssClass: 'state-manual'
            },
            'PARADA': {
                icon: '‚è∏Ô∏è',
                name: 'PARADA',
                description: 'M√°quina parada. Pressione o pedal para iniciar.',
                cssClass: 'state-idle'
            }
        };

        // ========================================
        // WEBSOCKET
        // ========================================
        function connectWebSocket() {
            const wsHost = window.location.hostname || 'localhost';
            ws = new WebSocket(`ws://${wsHost}:8765`);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                updateConnectionStatus('ws', true);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Mensagem recebida:', message);

                    // Mensagens WiFi
                    if (message.type && message.type.startsWith('wifi_')) {
                        handleWifiMessage(message);
                        return;
                    }

                    if (message.type === 'full_state' || message.type === 'state_update') {
                        handleStateUpdate(message.data || {});
                    } else {
                        handleStateUpdate(message);
                    }
                } catch (e) {
                    console.error('Erro ao processar mensagem:', e, event.data);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                updateConnectionStatus('ws', false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('Erro WebSocket:', error);
                updateConnectionStatus('ws', false);
            };
        }

        // ========================================
        // ATUALIZA√á√ÉO DE ESTADO
        // ========================================
        function handleStateUpdate(data) {
            // Status de conex√£o CLP
            if (data.modbus_connected !== undefined) {
                updateConnectionStatus('clp', data.modbus_connected);
            }

            // Estado da m√°quina
            if (data.machine_state_name !== undefined) {
                updateMachineState(data.machine_state_name, data.machine_state_description, data.machine_state_icon);
            }

            // Encoder (CORRIGIDO 02/Jan/2026: visualiza√ß√£o profissional)
            if (data.encoder_degrees !== undefined && data.encoder_degrees !== null) {
                const encoderEl = document.getElementById('encoderValue');
                encoderEl.textContent = data.encoder_degrees.toFixed(1) + '¬∞';

                // Anima√ß√£o de pulsa√ß√£o durante movimento
                if (data.encoder_moving) {
                    encoderEl.classList.add('moving');
                } else {
                    encoderEl.classList.remove('moving');
                }
            }

            // Pulsos do encoder (debug)
            if (data.encoder_pulses !== undefined) {
                document.getElementById('encoderPulses').textContent = data.encoder_pulses;
            }

            // Dire√ß√£o de rota√ß√£o (seta)
            if (data.encoder_direction_symbol !== undefined) {
                document.getElementById('encoderDirection').textContent = data.encoder_direction_symbol;
            }

            // Dobra atual
            if (data.dobra_atual !== undefined) {
                document.getElementById('currentBend').textContent = data.dobra_atual;
                updateAngleCardHighlight(data.dobra_atual);
            }

            // √Çngulo alvo
            if (data.target_angle !== undefined) {
                document.getElementById('targetAngle').textContent = data.target_angle.toFixed(1) + '¬∞';
            }

            // Contador de pe√ßas
            if (data.contador_pecas !== undefined) {
                document.getElementById('pieceCounter').textContent = data.contador_pecas;
            }

            // Velocidade
            if (data.velocidade_rpm !== undefined) {
                currentSpeed = data.velocidade_rpm;
                document.getElementById('speedValue').textContent = data.velocidade_rpm.toFixed(1);
                document.getElementById('speedSlider').value = data.velocidade_rpm;
            }

            // √Çngulos programados
            if (data.angles) {
                if (data.angles.bend_1 !== undefined) {
                    document.getElementById('angle1').textContent = data.angles.bend_1.toFixed(1);
                }
                if (data.angles.bend_2 !== undefined) {
                    document.getElementById('angle2').textContent = data.angles.bend_2.toFixed(1);
                }
                if (data.angles.bend_3 !== undefined) {
                    document.getElementById('angle3').textContent = data.angles.bend_3.toFixed(1);
                }
            }

            // Compatibilidade com formato antigo
            if (data.bend_1_left !== undefined) {
                document.getElementById('angle1').textContent = data.bend_1_left.toFixed(1);
            }
            if (data.bend_2_left !== undefined) {
                document.getElementById('angle2').textContent = data.bend_2_left.toFixed(1);
            }
            if (data.bend_3_left !== undefined) {
                document.getElementById('angle3').textContent = data.bend_3_left.toFixed(1);
            }

            // Control bits (PEDAL_SEGURA, MODO_MANUAL)
            if (data.control_bits) {
                if (data.control_bits.PEDAL_SEGURA !== undefined) {
                    pedalSeguraEnabled = data.control_bits.PEDAL_SEGURA;
                    updateToggle('pedalSeguraToggle', pedalSeguraEnabled);
                }
                if (data.control_bits.MODO_MANUAL !== undefined) {
                    manualModeEnabled = data.control_bits.MODO_MANUAL;
                    updateToggle('manualModeToggle', manualModeEnabled);
                }
            }

            // Alias direto
            if (data.pedal_segura !== undefined) {
                pedalSeguraEnabled = data.pedal_segura;
                updateToggle('pedalSeguraToggle', pedalSeguraEnabled);
            }
            if (data.mode_manual !== undefined) {
                manualModeEnabled = data.mode_manual;
                updateToggle('manualModeToggle', manualModeEnabled);
            }
        }

        function updateMachineState(stateName, description, icon) {
            const stateCard = document.getElementById('stateCard');
            const stateInfo = STATE_INFO[stateName] || STATE_INFO['PARADA'];

            // Remove todas as classes de estado
            stateCard.className = 'state-card';
            stateCard.classList.add(stateInfo.cssClass);

            document.getElementById('stateIcon').textContent = icon || stateInfo.icon;
            document.getElementById('stateName').textContent = stateInfo.name;
            document.getElementById('stateDescription').textContent = description || stateInfo.description;
        }

        function updateAngleCardHighlight(currentBend) {
            // Remove destaque de todos
            document.querySelectorAll('.angle-card').forEach(card => {
                card.classList.remove('active');
            });

            // Adiciona destaque no atual
            const currentCard = document.getElementById(`angleCard${currentBend}`);
            if (currentCard) {
                currentCard.classList.add('active');
            }
        }

        function updateToggle(toggleId, isActive) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.classList.toggle('active', isActive);
            }
        }

        function updateConnectionStatus(type, connected) {
            const dot = document.getElementById(type === 'ws' ? 'wsStatus' : 'clpStatus');
            const text = document.getElementById(type === 'ws' ? 'wsText' : 'clpText');

            dot.classList.toggle('connected', connected);
            text.textContent = connected ? (type === 'ws' ? 'WS' : 'CLP') : 'OFF';

            // Overlay de erro
            const overlay = document.getElementById('errorOverlay');
            const errorMsg = document.getElementById('errorMessage');

            if (type === 'ws' && !connected) {
                overlay.classList.add('active');
                errorMsg.textContent = 'DESCONECTADO';
            } else if (type === 'clp' && !connected && ws && ws.readyState === WebSocket.OPEN) {
                overlay.classList.add('active');
                errorMsg.textContent = 'FALHA CLP';
            } else if (connected && ws && ws.readyState === WebSocket.OPEN) {
                overlay.classList.remove('active');
            }
        }

        // ========================================
        // CONTROLES
        // ========================================
        function startMotor(direction) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'motor_control',
                command: direction === 'forward' ? 'start_forward' : 'start_backward'
            }));

            // Feedback visual
            document.getElementById('btnForward').classList.toggle('active', direction === 'forward');
            document.getElementById('btnReverse').classList.toggle('active', direction === 'reverse');
        }

        function stopMotor() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'motor_control',
                command: 'stop'
            }));

            document.getElementById('btnForward').classList.remove('active');
            document.getElementById('btnReverse').classList.remove('active');
        }

        // ========================================
        // VELOCIDADE (DIMMER)
        // ========================================
        const speedSlider = document.getElementById('speedSlider');
        let speedTimeout = null;

        speedSlider.addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = speed.toFixed(1);

            // Debounce: s√≥ envia ap√≥s parar de mover por 200ms
            clearTimeout(speedTimeout);
            speedTimeout = setTimeout(() => {
                sendSpeed(speed);
            }, 200);
        });

        function sendSpeed(speed) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'write_speed',
                speed: speed
            }));

            console.log(`Velocidade enviada: ${speed} RPM`);
        }

        // ========================================
        // TOGGLES
        // ========================================
        function togglePedalSegura() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            pedalSeguraEnabled = !pedalSeguraEnabled;
            updateToggle('pedalSeguraToggle', pedalSeguraEnabled);

            ws.send(JSON.stringify({
                action: 'write_pedal_segura',
                value: pedalSeguraEnabled
            }));

            console.log(`PEDAL_SEGURA: ${pedalSeguraEnabled ? 'ATIVADO' : 'DESATIVADO'}`);
        }

        function toggleManualMode() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            manualModeEnabled = !manualModeEnabled;
            updateToggle('manualModeToggle', manualModeEnabled);

            ws.send(JSON.stringify({
                action: 'set_manual_mode',
                value: manualModeEnabled
            }));

            console.log(`MODO MANUAL: ${manualModeEnabled ? 'ATIVADO' : 'DESATIVADO'}`);
        }

        function resetCounter() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            if (confirm('Zerar contador de pe√ßas?')) {
                ws.send(JSON.stringify({
                    action: 'reset_counter'
                }));

                document.getElementById('pieceCounter').textContent = '0';
                console.log('Contador de pe√ßas zerado');
            }
        }

        // ========================================
        // MODAL DE √ÇNGULO
        // ========================================
        function editAngle(bendNumber) {
            currentBendEdit = bendNumber;
            document.getElementById('modalTitle').textContent = `Editar √Çngulo - Dobra ${bendNumber}`;

            // Pega valor atual
            const currentValue = document.getElementById(`angle${bendNumber}`).textContent;
            document.getElementById('angleInput').value = currentValue;

            document.getElementById('angleModal').classList.add('active');
            setTimeout(() => document.getElementById('angleInput').focus(), 100);
        }

        function closeModal() {
            document.getElementById('angleModal').classList.remove('active');
            currentBendEdit = null;
        }

        function saveAngle() {
            if (!currentBendEdit || !ws || ws.readyState !== WebSocket.OPEN) return;

            const value = parseFloat(document.getElementById('angleInput').value);
            if (isNaN(value) || value < 0 || value > 360) {
                alert('√Çngulo inv√°lido! Use valores entre 0 e 360 graus.');
                return;
            }

            ws.send(JSON.stringify({
                action: 'write_angle',
                bend: currentBendEdit,
                angle: value
            }));

            document.getElementById(`angle${currentBendEdit}`).textContent = value.toFixed(1);
            closeModal();
        }

        // Enter no input salva
        document.getElementById('angleInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveAngle();
        });

        // ========================================
        // NAVEGA√á√ÉO POR ABAS
        // ========================================
        function switchTab(tabName) {
            // Remove active de todos os bot√µes e conte√∫dos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Ativa bot√£o e conte√∫do selecionado
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Se for aba WiFi, atualiza status
            if (tabName === 'wifi') {
                refreshWifiStatus();
            }
        }

        // ========================================
        // WIFI MANAGER
        // ========================================
        let wifiStatus = {
            dongle_detected: false,
            wifi_connected: false,
            nat_enabled: false
        };
        let selectedWifiNetwork = null;

        function refreshWifiStatus() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ action: 'wifi_status' }));
        }

        function updateWifiUI(data) {
            wifiStatus = data;

            // Status do AP
            document.getElementById('wifiApSsid').textContent = data.ap_ssid || 'IHM_NEOCOUDE';
            document.getElementById('wifiApIp').textContent = data.ap_ip || '-';

            // Status do Tailscale
            const tailscaleEl = document.getElementById('wifiTailscaleIp');
            if (data.tailscale_ip) {
                tailscaleEl.textContent = data.tailscale_ip;
                tailscaleEl.className = 'wifi-status-value connected';
            } else {
                tailscaleEl.textContent = 'N√£o conectado';
                tailscaleEl.className = 'wifi-status-value disconnected';
            }

            // Status do Dongle
            const dongleStatusEl = document.getElementById('wifiDongleStatus');
            const dongleIpEl = document.getElementById('wifiDongleIp');
            const dongleNotDetected = document.getElementById('wifiDongleNotDetected');
            const dongleForm = document.getElementById('wifiDongleForm');
            const btnDisconnect = document.getElementById('btnDisconnectWifi');

            if (data.dongle_detected) {
                dongleNotDetected.style.display = 'none';
                dongleForm.style.display = 'block';

                if (data.wifi_connected) {
                    dongleStatusEl.className = 'wifi-status-value connected';
                    dongleStatusEl.textContent = data.connected_ssid || 'Conectado';
                    dongleIpEl.textContent = data.dongle_ip || '-';
                    btnDisconnect.disabled = false;
                } else {
                    dongleStatusEl.className = 'wifi-status-value disconnected';
                    dongleStatusEl.textContent = 'Desconectado';
                    dongleIpEl.textContent = '-';
                    btnDisconnect.disabled = true;
                }

                // Preenche SSID salvo se existir
                if (data.config && data.config.ssid) {
                    document.getElementById('wifiSsidInput').value = data.config.ssid;
                    document.getElementById('wifiAutoConnect').checked = data.config.auto_connect !== false;
                }
            } else {
                dongleNotDetected.style.display = 'block';
                dongleForm.style.display = 'none';
                dongleStatusEl.className = 'wifi-status-value disconnected';
                dongleStatusEl.textContent = 'N√£o detectado';
                dongleIpEl.textContent = '-';
            }

            // Status do NAT
            const natToggle = document.getElementById('wifiNatToggle');
            const natStatus = document.getElementById('wifiNatStatus');
            if (data.nat_enabled) {
                natToggle.classList.add('active');
                natStatus.textContent = 'Status: Ativo - Internet compartilhada';
            } else {
                natToggle.classList.remove('active');
                natStatus.textContent = 'Status: Inativo';
            }
        }

        function scanWifiNetworks() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const btn = document.getElementById('btnScanWifi');
            btn.disabled = true;
            btn.innerHTML = '<div class="wifi-loading-spinner"></div> Escaneando...';

            const listEl = document.getElementById('wifiNetworksList');
            listEl.innerHTML = '<div class="wifi-loading"><div class="wifi-loading-spinner"></div><br>Escaneando redes...</div>';

            ws.send(JSON.stringify({ action: 'wifi_scan' }));
        }

        function displayWifiNetworks(networks) {
            const listEl = document.getElementById('wifiNetworksList');
            const btn = document.getElementById('btnScanWifi');

            btn.disabled = false;
            btn.innerHTML = 'üì° Escanear Redes';

            if (!networks || networks.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:15px; opacity:0.7;">Nenhuma rede encontrada</div>';
                return;
            }

            listEl.innerHTML = networks.map(net => `
                <div class="wifi-network-item ${selectedWifiNetwork === net.ssid ? 'selected' : ''}"
                     onclick="selectWifiNetwork('${net.ssid}')">
                    <span class="wifi-network-ssid">${net.ssid}</span>
                    <span class="wifi-network-signal">${getSignalIcon(net.signal)} ${net.signal || '?'} dBm</span>
                </div>
            `).join('');
        }

        function getSignalIcon(signal) {
            if (!signal) return 'üì∂';
            if (signal >= -50) return 'üì∂';
            if (signal >= -70) return 'üì∂';
            return 'üì∂';
        }

        function selectWifiNetwork(ssid) {
            selectedWifiNetwork = ssid;
            document.getElementById('wifiSsidInput').value = ssid;
            document.getElementById('wifiPasswordInput').focus();

            // Atualiza visual da lista
            document.querySelectorAll('.wifi-network-item').forEach(item => {
                item.classList.toggle('selected', item.querySelector('.wifi-network-ssid').textContent === ssid);
            });
        }

        function connectWifi() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const ssid = document.getElementById('wifiSsidInput').value.trim();
            const password = document.getElementById('wifiPasswordInput').value;

            if (!ssid) {
                alert('Digite o nome da rede (SSID)');
                return;
            }
            if (!password) {
                alert('Digite a senha da rede');
                return;
            }

            ws.send(JSON.stringify({
                action: 'wifi_connect',
                ssid: ssid,
                password: password
            }));

            // Feedback visual
            const dongleStatusEl = document.getElementById('wifiDongleStatus');
            dongleStatusEl.textContent = 'Conectando...';
            dongleStatusEl.className = 'wifi-status-value';
        }

        function disconnectWifi() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ action: 'wifi_disconnect' }));
        }

        function saveWifiConfig() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const ssid = document.getElementById('wifiSsidInput').value.trim();
            const password = document.getElementById('wifiPasswordInput').value;
            const autoConnect = document.getElementById('wifiAutoConnect').checked;

            if (!ssid || !password) {
                alert('Preencha SSID e senha para salvar');
                return;
            }

            ws.send(JSON.stringify({
                action: 'wifi_save_config',
                ssid: ssid,
                password: password,
                auto_connect: autoConnect
            }));

            alert('Configura√ß√£o salva!');
        }

        function toggleNat() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const natToggle = document.getElementById('wifiNatToggle');
            const isActive = natToggle.classList.contains('active');

            if (isActive) {
                ws.send(JSON.stringify({ action: 'wifi_disable_nat' }));
            } else {
                ws.send(JSON.stringify({ action: 'wifi_enable_nat' }));
            }
        }

        // Handler de mensagens WiFi
        function handleWifiMessage(message) {
            switch (message.type) {
                case 'wifi_status':
                    updateWifiUI(message.data);
                    break;
                case 'wifi_scan_result':
                    displayWifiNetworks(message.networks);
                    break;
                case 'wifi_connecting':
                    document.getElementById('wifiDongleStatus').textContent = `Conectando em ${message.ssid}...`;
                    break;
                case 'wifi_connect_result':
                    if (message.success) {
                        alert(`Conectado em ${message.ssid}!`);
                    } else {
                        alert(`Falha: ${message.message}`);
                    }
                    refreshWifiStatus();
                    break;
                case 'wifi_disconnect_result':
                    refreshWifiStatus();
                    break;
                case 'wifi_config_saved':
                    console.log('Config WiFi salva:', message.ssid);
                    break;
                case 'wifi_nat_result':
                    const natToggle = document.getElementById('wifiNatToggle');
                    const natStatus = document.getElementById('wifiNatStatus');
                    if (message.enabled) {
                        natToggle.classList.add('active');
                        natStatus.textContent = 'Status: Ativo - Internet compartilhada';
                    } else {
                        natToggle.classList.remove('active');
                        natStatus.textContent = 'Status: Inativo';
                    }
                    break;
            }
        }

        // ========================================
        // AUTO-CALIBRA√á√ÉO - DESATIVADO 02/Jan/2026
        // ========================================
        // Calibra√ß√£o manual via ajuste de √¢ngulos
        // C√≥digo comentado para facilitar futura reativa√ß√£o

        // let calibrationState = {
        //     active: false,
        //     warmup: true,
        //     stepCode: 0,
        //     progress: 0,
        //     lastEncoderAngle: 0
        // };
        //
        // function toggleCalibWarmup() { /* DESATIVADO */ }
        // function startCalibration() { /* DESATIVADO */ }
        // function abortCalibration() { /* DESATIVADO */ }
        // function updateCalibrationUI(data) { /* DESATIVADO */ }
        // function updateMotorAnimation(data) { /* DESATIVADO */ }
        // function updateCalibrationLock(isCalibrating) { /* DESATIVADO */ }
        // function handleCalibrationMessage(message) { /* DESATIVADO */ }

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        connectWebSocket();
    </script>
</body>
</html>
