<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>IHM - NEOCOUDE-HD-15</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(0,0,0,0.4);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 16px;
            font-weight: 700;
        }

        .header-status {
            display: flex;
            gap: 12px;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
            box-shadow: 0 0 10px currentColor;
            transition: all 0.3s;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        /* Container principal */
        .main-container {
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Card de Estado da M√°quina - DESTAQUE */
        .state-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .state-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .state-description {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 8px;
        }

        /* Estados com cores espec√≠ficas */
        .state-card.state-idle { border-color: #95a5a6; }
        .state-card.state-aguarda-direcao { border-color: #f39c12; }
        .state-card.state-dobrando { border-color: #2ecc71; }
        .state-card.state-retornando { border-color: #3498db; }
        .state-card.state-aguarda-proxima { border-color: #9b59b6; }
        .state-card.state-completo { border-color: #27ae60; }
        .state-card.state-emergencia { border-color: #e74c3c; background: rgba(231,76,60,0.2); }
        .state-card.state-manual { border-color: #e67e22; }

        /* Grid de informa√ß√µes */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .info-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .info-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 700;
        }

        .info-value.encoder {
            color: #2ecc71;
            text-shadow: 0 0 15px rgba(46,204,113,0.5);
        }

        .info-value.counter {
            color: #3498db;
        }

        /* √Çngulos em grid compacto */
        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .angles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .angle-card {
            background: rgba(255,255,255,0.12);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .angle-card:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.2);
        }

        .angle-card.active {
            border-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46,204,113,0.3);
        }

        .angle-card-label {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .angle-card-value {
            font-size: 20px;
            font-weight: 700;
        }

        .angle-card-unit {
            font-size: 14px;
            opacity: 0.6;
        }

        /* Dimmer de Velocidade */
        .dimmer-section {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .dimmer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dimmer-label {
            font-size: 12px;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .dimmer-value {
            font-size: 20px;
            font-weight: 700;
            color: #3498db;
        }

        .dimmer-slider {
            width: 100%;
            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #2ecc71 0%, #f39c12 50%, #e74c3c 100%);
            border-radius: 20px;
            outline: none;
            cursor: pointer;
        }

        .dimmer-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 50px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .dimmer-slider::-moz-range-thumb {
            width: 30px;
            height: 50px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .dimmer-marks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 10px;
            opacity: 0.6;
        }

        /* Controles de Motor */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            padding: 18px 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.active {
            background: #2ecc71;
            border-color: #2ecc71;
            box-shadow: 0 0 20px rgba(46,204,113,0.5);
        }

        .control-btn.stop {
            background: rgba(231,76,60,0.3);
            border-color: rgba(231,76,60,0.5);
        }

        .control-btn.stop:active {
            background: #e74c3c;
        }

        .control-icon {
            font-size: 28px;
        }

        /* Switches/Toggles */
        .toggles-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-info {
            flex: 1;
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .toggle-description {
            font-size: 10px;
            opacity: 0.6;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #2ecc71;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* Bot√£o Reset Contador */
        .reset-btn {
            background: rgba(231,76,60,0.2);
            border: 2px solid rgba(231,76,60,0.4);
            border-radius: 8px;
            color: #fff;
            font-size: 10px;
            padding: 6px 10px;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s;
        }

        .reset-btn:active {
            background: #e74c3c;
        }

        /* Footer */
        .footer {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            text-align: center;
            font-size: 10px;
            opacity: 0.7;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .footer a {
            color: #2ecc71;
            text-decoration: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 28px;
            font-weight: 700;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .modal-btn.confirm {
            background: #2ecc71;
            border-color: #2ecc71;
        }

        /* Overlay de erro */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(231,76,60,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .overlay.active {
            display: flex;
        }

        .overlay-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .overlay-message {
            font-size: 36px;
            font-weight: 900;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsivo */
        @media (min-width: 768px) {
            .main-container {
                padding: 20px 30px;
            }

            .info-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .state-card {
                padding: 25px;
            }

            .state-icon {
                font-size: 56px;
            }

            .state-name {
                font-size: 24px;
            }
        }

        @media (max-height: 600px) {
            .state-card {
                padding: 12px;
            }

            .state-icon {
                font-size: 36px;
                margin-bottom: 5px;
            }

            .state-name {
                font-size: 16px;
            }

            .state-description {
                font-size: 12px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay de erro -->
    <div class="overlay" id="errorOverlay">
        <div class="overlay-icon">‚ö†Ô∏è</div>
        <div class="overlay-message" id="errorMessage">DESLIGADO</div>
    </div>

    <!-- Modal para editar √¢ngulo -->
    <div class="modal" id="angleModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Editar √Çngulo - Dobra 1</div>
            <input type="number" class="modal-input" id="angleInput" placeholder="0.0" step="0.1" min="0" max="360">
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn confirm" onclick="saveAngle()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title">NEOCOUDE-HD-15</div>
        <div class="header-status">
            <div class="status-item">
                <span class="status-dot" id="wsStatus"></span>
                <span id="wsText">WS</span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="clpStatus"></span>
                <span id="clpText">CLP</span>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="main-container">
        <!-- Card de Estado da M√°quina -->
        <div class="state-card" id="stateCard">
            <div class="state-icon" id="stateIcon">‚è∏Ô∏è</div>
            <div class="state-name" id="stateName">PARADA</div>
            <div class="state-description" id="stateDescription">
                M√°quina parada. Pressione o pedal para iniciar uma opera√ß√£o.
            </div>
        </div>

        <!-- Grid de Informa√ß√µes -->
        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">Posi√ß√£o Encoder</div>
                <div class="info-value encoder" id="encoderValue">0.0¬∞</div>
            </div>
            <div class="info-card">
                <div class="info-label">Dobra Atual</div>
                <div class="info-value" id="currentBend">1</div>
            </div>
            <div class="info-card">
                <div class="info-label">√Çngulo Alvo</div>
                <div class="info-value" id="targetAngle">0.0¬∞</div>
            </div>
            <div class="info-card">
                <div class="info-label">Pe√ßas Produzidas</div>
                <div class="info-value counter" id="pieceCounter">0</div>
                <button class="reset-btn" onclick="resetCounter()">ZERAR</button>
            </div>
        </div>

        <!-- √Çngulos Programados -->
        <div class="section-title">√Çngulos Programados</div>
        <div class="angles-grid">
            <div class="angle-card" id="angleCard1" onclick="editAngle(1)">
                <div class="angle-card-label">DOBRA 1</div>
                <div class="angle-card-value">
                    <span id="angle1">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
            <div class="angle-card" id="angleCard2" onclick="editAngle(2)">
                <div class="angle-card-label">DOBRA 2</div>
                <div class="angle-card-value">
                    <span id="angle2">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
            <div class="angle-card" id="angleCard3" onclick="editAngle(3)">
                <div class="angle-card-label">DOBRA 3</div>
                <div class="angle-card-value">
                    <span id="angle3">90.0</span><span class="angle-card-unit">¬∞</span>
                </div>
            </div>
        </div>

        <!-- Dimmer de Velocidade -->
        <div class="dimmer-section">
            <div class="dimmer-header">
                <span class="dimmer-label">Velocidade do Motor</span>
                <span class="dimmer-value"><span id="speedValue">5.0</span> RPM</span>
            </div>
            <input type="range" class="dimmer-slider" id="speedSlider" min="0" max="19" step="0.5" value="5">
            <div class="dimmer-marks">
                <span>0</span>
                <span>5</span>
                <span>10</span>
                <span>15</span>
                <span>19 RPM</span>
            </div>
        </div>

        <!-- Controles de Motor -->
        <div class="section-title">Controle do Motor</div>
        <div class="controls-grid">
            <button class="control-btn" id="btnForward" onclick="startMotor('forward')">
                <div class="control-icon">‚¨ÜÔ∏è</div>
                <div>AVAN√áAR</div>
            </button>
            <button class="control-btn stop" onclick="stopMotor()">
                <div class="control-icon">‚èπÔ∏è</div>
                <div>PARAR</div>
            </button>
            <button class="control-btn" id="btnReverse" onclick="startMotor('reverse')">
                <div class="control-icon">‚¨áÔ∏è</div>
                <div>RECUAR</div>
            </button>
        </div>

        <!-- Toggles de Configura√ß√£o -->
        <div class="section-title">Configura√ß√µes</div>
        <div class="toggles-section">
            <div class="toggle-card">
                <div class="toggle-info">
                    <div class="toggle-label">PEDAL SEGURA</div>
                    <div class="toggle-description">Exige segurar pedal</div>
                </div>
                <div class="toggle-switch" id="pedalSeguraToggle" onclick="togglePedalSegura()"></div>
            </div>
            <div class="toggle-card">
                <div class="toggle-info">
                    <div class="toggle-label">MODO MANUAL</div>
                    <div class="toggle-description">Controle direto</div>
                </div>
                <div class="toggle-switch" id="manualModeToggle" onclick="toggleManualMode()"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        Desenvolvido por Eng. <a href="https://www.linkedin.com/in/lucas-william-junges-a95b00143" target="_blank">Lucas William Junges</a> | IHM Web v2.0
    </div>

    <script>
        // ========================================
        // ESTADO DA APLICA√á√ÉO
        // ========================================
        let ws = null;
        let currentBendEdit = null;
        let currentSpeed = 5.0;
        let pedalSeguraEnabled = false;
        let manualModeEnabled = false;

        // Mapeamento de estados para descri√ß√µes amig√°veis
        const STATE_INFO = {
            'ST_IDLE': {
                icon: '‚è∏Ô∏è',
                name: 'PARADA',
                description: 'M√°quina parada. Pressione o pedal para iniciar uma opera√ß√£o.',
                cssClass: 'state-idle'
            },
            'ST_AGUARDA_DIRECAO': {
                icon: 'üéØ',
                name: 'AGUARDANDO DIRE√á√ÉO',
                description: 'Escolha a dire√ß√£o: pressione pedal de avan√ßo ou recuo.',
                cssClass: 'state-aguarda-direcao'
            },
            'ST_DOBRANDO': {
                icon: 'üîÑ',
                name: 'DOBRANDO',
                description: 'Executando dobra. Motor em movimento at√© atingir o √¢ngulo alvo.',
                cssClass: 'state-dobrando'
            },
            'ST_RETORNANDO': {
                icon: '‚Ü©Ô∏è',
                name: 'RETORNANDO',
                description: 'Retornando para posi√ß√£o zero. Aguarde a conclus√£o.',
                cssClass: 'state-retornando'
            },
            'ST_AGUARDA_PROXIMA': {
                icon: '‚è≥',
                name: 'PR√ìXIMA DOBRA',
                description: 'Dobra conclu√≠da! Pressione o pedal para a pr√≥xima dobra.',
                cssClass: 'state-aguarda-proxima'
            },
            'ST_COMPLETO': {
                icon: '‚úÖ',
                name: 'SEQU√äNCIA COMPLETA',
                description: 'Todas as 3 dobras foram conclu√≠das com sucesso!',
                cssClass: 'state-completo'
            },
            'ST_EMERGENCIA': {
                icon: 'üö®',
                name: 'EMERG√äNCIA',
                description: 'PARADA DE EMERG√äNCIA ATIVA! Resolva o problema e reinicie.',
                cssClass: 'state-emergencia'
            },
            'ST_MANUAL': {
                icon: 'üîß',
                name: 'MODO MANUAL',
                description: 'Controle manual ativo. Use os bot√µes para mover o motor.',
                cssClass: 'state-manual'
            },
            'PARADA': {
                icon: '‚è∏Ô∏è',
                name: 'PARADA',
                description: 'M√°quina parada. Pressione o pedal para iniciar.',
                cssClass: 'state-idle'
            }
        };

        // ========================================
        // WEBSOCKET
        // ========================================
        function connectWebSocket() {
            const wsHost = window.location.hostname || 'localhost';
            ws = new WebSocket(`ws://${wsHost}:8765`);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                updateConnectionStatus('ws', true);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Mensagem recebida:', message);

                    if (message.type === 'full_state' || message.type === 'state_update') {
                        handleStateUpdate(message.data || {});
                    } else {
                        handleStateUpdate(message);
                    }
                } catch (e) {
                    console.error('Erro ao processar mensagem:', e, event.data);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                updateConnectionStatus('ws', false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('Erro WebSocket:', error);
                updateConnectionStatus('ws', false);
            };
        }

        // ========================================
        // ATUALIZA√á√ÉO DE ESTADO
        // ========================================
        function handleStateUpdate(data) {
            // Status de conex√£o CLP
            if (data.modbus_connected !== undefined) {
                updateConnectionStatus('clp', data.modbus_connected);
            }

            // Estado da m√°quina
            if (data.machine_state_name !== undefined) {
                updateMachineState(data.machine_state_name, data.machine_state_description, data.machine_state_icon);
            }

            // Encoder
            if (data.encoder_degrees !== undefined && data.encoder_degrees !== null) {
                document.getElementById('encoderValue').textContent = data.encoder_degrees.toFixed(1) + '¬∞';
            }

            // Dobra atual
            if (data.dobra_atual !== undefined) {
                document.getElementById('currentBend').textContent = data.dobra_atual;
                updateAngleCardHighlight(data.dobra_atual);
            }

            // √Çngulo alvo
            if (data.target_angle !== undefined) {
                document.getElementById('targetAngle').textContent = data.target_angle.toFixed(1) + '¬∞';
            }

            // Contador de pe√ßas
            if (data.contador_pecas !== undefined) {
                document.getElementById('pieceCounter').textContent = data.contador_pecas;
            }

            // Velocidade
            if (data.velocidade_rpm !== undefined) {
                currentSpeed = data.velocidade_rpm;
                document.getElementById('speedValue').textContent = data.velocidade_rpm.toFixed(1);
                document.getElementById('speedSlider').value = data.velocidade_rpm;
            }

            // √Çngulos programados
            if (data.angles) {
                if (data.angles.bend_1 !== undefined) {
                    document.getElementById('angle1').textContent = data.angles.bend_1.toFixed(1);
                }
                if (data.angles.bend_2 !== undefined) {
                    document.getElementById('angle2').textContent = data.angles.bend_2.toFixed(1);
                }
                if (data.angles.bend_3 !== undefined) {
                    document.getElementById('angle3').textContent = data.angles.bend_3.toFixed(1);
                }
            }

            // Compatibilidade com formato antigo
            if (data.bend_1_left !== undefined) {
                document.getElementById('angle1').textContent = data.bend_1_left.toFixed(1);
            }
            if (data.bend_2_left !== undefined) {
                document.getElementById('angle2').textContent = data.bend_2_left.toFixed(1);
            }
            if (data.bend_3_left !== undefined) {
                document.getElementById('angle3').textContent = data.bend_3_left.toFixed(1);
            }

            // Control bits (PEDAL_SEGURA, MODO_MANUAL)
            if (data.control_bits) {
                if (data.control_bits.PEDAL_SEGURA !== undefined) {
                    pedalSeguraEnabled = data.control_bits.PEDAL_SEGURA;
                    updateToggle('pedalSeguraToggle', pedalSeguraEnabled);
                }
                if (data.control_bits.MODO_MANUAL !== undefined) {
                    manualModeEnabled = data.control_bits.MODO_MANUAL;
                    updateToggle('manualModeToggle', manualModeEnabled);
                }
            }

            // Alias direto
            if (data.pedal_segura !== undefined) {
                pedalSeguraEnabled = data.pedal_segura;
                updateToggle('pedalSeguraToggle', pedalSeguraEnabled);
            }
            if (data.mode_manual !== undefined) {
                manualModeEnabled = data.mode_manual;
                updateToggle('manualModeToggle', manualModeEnabled);
            }
        }

        function updateMachineState(stateName, description, icon) {
            const stateCard = document.getElementById('stateCard');
            const stateInfo = STATE_INFO[stateName] || STATE_INFO['PARADA'];

            // Remove todas as classes de estado
            stateCard.className = 'state-card';
            stateCard.classList.add(stateInfo.cssClass);

            document.getElementById('stateIcon').textContent = icon || stateInfo.icon;
            document.getElementById('stateName').textContent = stateInfo.name;
            document.getElementById('stateDescription').textContent = description || stateInfo.description;
        }

        function updateAngleCardHighlight(currentBend) {
            // Remove destaque de todos
            document.querySelectorAll('.angle-card').forEach(card => {
                card.classList.remove('active');
            });

            // Adiciona destaque no atual
            const currentCard = document.getElementById(`angleCard${currentBend}`);
            if (currentCard) {
                currentCard.classList.add('active');
            }
        }

        function updateToggle(toggleId, isActive) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.classList.toggle('active', isActive);
            }
        }

        function updateConnectionStatus(type, connected) {
            const dot = document.getElementById(type === 'ws' ? 'wsStatus' : 'clpStatus');
            const text = document.getElementById(type === 'ws' ? 'wsText' : 'clpText');

            dot.classList.toggle('connected', connected);
            text.textContent = connected ? (type === 'ws' ? 'WS' : 'CLP') : 'OFF';

            // Overlay de erro
            const overlay = document.getElementById('errorOverlay');
            const errorMsg = document.getElementById('errorMessage');

            if (type === 'ws' && !connected) {
                overlay.classList.add('active');
                errorMsg.textContent = 'DESCONECTADO';
            } else if (type === 'clp' && !connected && ws && ws.readyState === WebSocket.OPEN) {
                overlay.classList.add('active');
                errorMsg.textContent = 'FALHA CLP';
            } else if (connected && ws && ws.readyState === WebSocket.OPEN) {
                overlay.classList.remove('active');
            }
        }

        // ========================================
        // CONTROLES
        // ========================================
        function startMotor(direction) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'motor_control',
                command: direction === 'forward' ? 'start_forward' : 'start_backward'
            }));

            // Feedback visual
            document.getElementById('btnForward').classList.toggle('active', direction === 'forward');
            document.getElementById('btnReverse').classList.toggle('active', direction === 'reverse');
        }

        function stopMotor() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'motor_control',
                command: 'stop'
            }));

            document.getElementById('btnForward').classList.remove('active');
            document.getElementById('btnReverse').classList.remove('active');
        }

        // ========================================
        // VELOCIDADE (DIMMER)
        // ========================================
        const speedSlider = document.getElementById('speedSlider');
        let speedTimeout = null;

        speedSlider.addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            document.getElementById('speedValue').textContent = speed.toFixed(1);

            // Debounce: s√≥ envia ap√≥s parar de mover por 200ms
            clearTimeout(speedTimeout);
            speedTimeout = setTimeout(() => {
                sendSpeed(speed);
            }, 200);
        });

        function sendSpeed(speed) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                action: 'write_speed',
                speed: speed
            }));

            console.log(`Velocidade enviada: ${speed} RPM`);
        }

        // ========================================
        // TOGGLES
        // ========================================
        function togglePedalSegura() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            pedalSeguraEnabled = !pedalSeguraEnabled;
            updateToggle('pedalSeguraToggle', pedalSeguraEnabled);

            ws.send(JSON.stringify({
                action: 'write_pedal_segura',
                value: pedalSeguraEnabled
            }));

            console.log(`PEDAL_SEGURA: ${pedalSeguraEnabled ? 'ATIVADO' : 'DESATIVADO'}`);
        }

        function toggleManualMode() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            manualModeEnabled = !manualModeEnabled;
            updateToggle('manualModeToggle', manualModeEnabled);

            ws.send(JSON.stringify({
                action: 'set_manual_mode',
                value: manualModeEnabled
            }));

            console.log(`MODO MANUAL: ${manualModeEnabled ? 'ATIVADO' : 'DESATIVADO'}`);
        }

        function resetCounter() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            if (confirm('Zerar contador de pe√ßas?')) {
                ws.send(JSON.stringify({
                    action: 'reset_counter'
                }));

                document.getElementById('pieceCounter').textContent = '0';
                console.log('Contador de pe√ßas zerado');
            }
        }

        // ========================================
        // MODAL DE √ÇNGULO
        // ========================================
        function editAngle(bendNumber) {
            currentBendEdit = bendNumber;
            document.getElementById('modalTitle').textContent = `Editar √Çngulo - Dobra ${bendNumber}`;

            // Pega valor atual
            const currentValue = document.getElementById(`angle${bendNumber}`).textContent;
            document.getElementById('angleInput').value = currentValue;

            document.getElementById('angleModal').classList.add('active');
            setTimeout(() => document.getElementById('angleInput').focus(), 100);
        }

        function closeModal() {
            document.getElementById('angleModal').classList.remove('active');
            currentBendEdit = null;
        }

        function saveAngle() {
            if (!currentBendEdit || !ws || ws.readyState !== WebSocket.OPEN) return;

            const value = parseFloat(document.getElementById('angleInput').value);
            if (isNaN(value) || value < 0 || value > 360) {
                alert('√Çngulo inv√°lido! Use valores entre 0 e 360 graus.');
                return;
            }

            ws.send(JSON.stringify({
                action: 'write_angle',
                bend: currentBendEdit,
                angle: value
            }));

            document.getElementById(`angle${currentBendEdit}`).textContent = value.toFixed(1);
            closeModal();
        }

        // Enter no input salva
        document.getElementById('angleInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveAngle();
        });

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        connectWebSocket();
    </script>
</body>
</html>
